<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Smart TRK - Map</title>
    <link rel="shortcut icon" href="../../common/favicon.png">
    <link rel="stylesheet" type="text/css" href="../../css/map.css">
    <img src="../../common/syswinBackground.png" class="bg" />

    <link rel="stylesheet" href="../../../bower_components/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="../../../bower_components/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../../bower_components/bootstrap-select/bootstrap-select.css" />

    <script src="../../../bower_components/jquery/dist/jquery.min.js"></script>
    <script src="../../../bower_components/bootstrap-select/bootstrap-select.js"></script>
    <script src="../../../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>

    <script>
        var map;

        var stableLocations = [new google.maps.LatLng(44.434278, 26.034482), new google.maps.LatLng(44.467140, 26.078481), new google.maps.LatLng(44.464506, 26.126246)];
        var alertLocations = [new google.maps.LatLng(44.426350, 26.091400), new google.maps.LatLng(44.433808, 25.998765)];
        var vehicleLocations = [new google.maps.LatLng(44.442421, 26.165643), new google.maps.LatLng(44.405542, 26.062686), new google.maps.LatLng(44.457440, 26.060730), new google.maps.LatLng(44.382212, 26.149736)];

        var stableMarkers = [];
        var alertMarkers = [];
        var vehicleMarkers = [];

        var displayStable = true;
        var displayAlarms = true;
        var displayVehicles = true;

        var pinPointStable = "../../common/green-PinPoint.png";
        var pinPointAlerts = "../../common/orange-PinPoint.png";
        var pinPointVehicle = "../../common/pinPoint-Vehicle.png";

        var locationsArray;

        var STABLE = "stable";
        var ALARM = "alarm";
        var VEHICLE = "vehicle";

        function initialize() {
            if (!getLocations()){
                return;
            }

            var mapOptions = {
                zoom: 12,
                center: new google.maps.LatLng(44.434912, 26.103115)
            };
            map = new google.maps.Map(document.getElementById('map-canvas'),
                    mapOptions);

            for (var i = 0; i < stableLocations.length; i++) {
                addMarker(stableLocations[i], STABLE);
            }

            for (var i = 0; i < alertLocations.length; i++) {
                addMarker(alertLocations[i], ALARM);
            }

            for (var i = 0; i < vehicleLocations.length; i++) {
                addMarker(vehicleLocations[i], VEHICLE);
            }
        }

        google.maps.event.addDomListener(window, 'load', initialize);

        function getLocations(){
            locationsGET();

            if(locationsArray != null){
                console.log(locationsArray);
                return true;
            }
            else{
                alert("An error occured while retrieving the locations. This feature might be disabled at the moment. Please contact the administrators.");
                console.log("Error retrieving locations.");
                return false;
            }
        }

        function locationsGET(){
            var urlRequest = "/map/locations";

            $.ajax({
                async: false,
                type: "GET",
                url: urlRequest,
                success: okGetLocations,
                error: failGetLocations,
                contentType: "application/json"
            });

            return false;
        }

        function okGetLocations(data){
            locationsArray = data;
        }

        function failGetLocations(){
            alert("An ERROR occurred while retrieving the locations.");
        }

        function addMarker(location, type) {
            var image;

            if( type == STABLE){
                image = pinPointStable;
            }
            if( type == ALARM){
                image = pinPointAlerts;
            }
            if( type == VEHICLE){
                image = pinPointVehicle;
            }

            var marker = new google.maps.Marker({
                position: location,
                map: map,
                icon: image,
                animation: google.maps.Animation.DROP
            });

            var contentString = '<div id="content">'+
                    '<div id="siteNotice">'+
                        '</div>'+
                        '<h2 id="firstHeading" class="firstHeading">Asset</h2>'+
                        '<div id="bodyContent">'+
                            '<p>TODO: To complete this HTML page.</p>'+
                        '</div>'+
                    '</div>';

            var infowindow = new google.maps.InfoWindow({
                //content: "TODO: To write the information"
                content: contentString
            });

            google.maps.event.addListener(marker, 'click', function() {
                infowindow.open(map, marker);
            });

            if( type == STABLE){
                stableMarkers.push(marker);
            }
            if( type == ALARM){
                alertMarkers.push(marker);
            }
            if( type == VEHICLE){
                vehicleMarkers.push(marker);
            }
        }

        function stableCheckbox(element){
            displayStable = element.checked;
            if (displayStable == true) {
                for (var i = 0; i < stableLocations.length; i++) {
                    addMarker(stableLocations[i], STABLE);
                }
            }else{
                for (var i = 0; i < stableMarkers.length; i++) {
                    stableMarkers[i].setMap(null);
                }
                stableMarkers = [];
            }
        }

        function alarmsCheckbox(element){
            displayAlarms = element.checked;
            if (displayAlarms == true) {
                for (var i = 0; i < alertLocations.length; i++) {
                    addMarker(alertLocations[i], ALARM);
                }
            }else{
                for (var i = 0; i < alertMarkers.length; i++) {
                    alertMarkers[i].setMap(null);
                }
                alertMarkers = [];
            }
        }

        function vehicleCheckbox(element){
            displayVehicles = element.checked;
            if (displayVehicles == true) {
                for (var i = 0; i < vehicleLocations.length; i++) {
                    addMarker(vehicleLocations[i], VEHICLE);
                }
            }else{
                for (var i = 0; i < vehicleMarkers.length; i++) {
                    vehicleMarkers[i].setMap(null);
                }
                vehicleMarkers = [];
            }
        }

        setInterval(function() {
            if (displayVehicles == true) {
                for (var i = 0; i < vehicleMarkers.length; i++) {
                    vehicleMarkers[i].setPosition(new google.maps.LatLng(vehicleMarkers[i].getPosition().lat() + 0.0001, vehicleMarkers[i].getPosition().lng() + 0.0001));
                    vehicleMarkers[i].setMap(map);
                }
            }
        }, 500);

    </script>

</head>
<body>
<header>
    <div class="container">
        <nav class="navbar navbar-default" role="navigation">
            <div class="container-fluid">
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li><a class="navbar-brand" href="http://dev.threepress.es/syswin/"><strong>Smart <font color="#33ADFF">TRK</font></strong></a></li>
                        <li><a href="../../home.html"><strong><font size="4">Home</font></strong></a></li>
                        <li><a href="../../about.html"><strong><font size="4">About</font></strong></a></li>
                        <li><a href="../../contact.html"><strong><font size="4">Contact</font></strong></a></li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown"><strong><font size="4">Options</font></strong><span class="caret"></span></a>
                            <ul class="dropdown-menu multi-level" role="menu" aria-labelledby="dropdownMenu">
                                <li><a href="../users.html"><strong><font size="3.8">Users</font></strong></a></li>
                                <li class="divider"></li>
                                <li class="dropdown-submenu">
                                    <a tabindex="-1" href="#"><strong><font size="3.8">Devices</font></strong></a>
                                    <ul class="dropdown-menu">
                                        <li><a href="logs.html"><strong><font size="3">Logs</font></strong></a></li><br>
                                        <li><a href="statistics.html"><strong><font size="3">Statistics</font></strong></a></li><br>
                                        <li><a href="#"><strong><font size="3">Map</font></strong></a></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="active"><a href="#"><strong><font size="4">Map</font></strong></a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        </li><li><p style="float: right" class="navbar-text"><font size="3"><b>USER:</b></font> adminUser</p></li>
                        <li><a style="float: right" href="../../login.html"><font size="3"><i>[logout]</i></font></a></li>
                    </ul>
                </div><!-- /.navbar-collapse -->
            </div><!-- /.container-fluid -->
        </nav>
    </div>

</header>

    <div class="container">
        <!-- Example row of columns -->
        <div class="row">
            <div class="col-sm-12 col-lg-12">
                <div class="panel">
                    <div class="panel-heading">
                        <h3>
                            <i style="color: #00b3ee" class="icon-location-arrow main-color"></i> Assets Map
                            <div style="float: right;  padding: 0px;">
                                <i style="color: #00b3ee; padding-right: 5px" class="icon-filter main-color"></i><font style="padding-right: 20px;">Filters</font>

                                <form style="display:inline; margin:0px; padding:0px;/" name="input" action="" method="get">
                                    <input onchange="stableCheckbox(this)" type="checkbox" name="stableFilter" id="stable1" checked/>
                                    <label for="stable1" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; color: #3e8f3e; padding-left: 5px; padding-right: 10px"><span></span>Stable</label>

                                    <input onchange="alarmsCheckbox(this)" type="checkbox" name="alarmFilter" id="alarms1" checked/>
                                    <label for="alarms1" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; color: #d58512; padding-left: 5px; padding-right: 10px"><span></span>Alarms</label>

                                    <input onchange="vehicleCheckbox(this)" type="checkbox" name="vehicleFilter" id="vehicles1" checked/>
                                    <label for="vehicles1" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; color: #5C5CD6; padding-left: 5px; padding-right: 10px"><span></span>Vehicles</label>
                                </form>
                            </div>
                        </h3>
                    </div>
                    <div class="panel-body">
                        <div id="map-canvas"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>